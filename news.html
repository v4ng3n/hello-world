<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>News – RSS Reader</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Page-specific styles for News */
    .controls { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    @media (min-width: 720px) { .grid { grid-template-columns: 1fr 1fr; } }
    .card {
      background: #fff; border-radius: 8px; padding: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex; flex-direction: column; gap: 0.5rem;
    }
    .card h3 { margin: 0; font-size: 1.05rem; }
    .meta { font-size: 0.9rem; color: #555; }
    .source { font-weight: bold; }
    .error { color: #b00020; }
    code.inline { background: #eee; padding: 0.05rem 0.3rem; border-radius: 4px; }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Home</a>
    <a href="weather.html">Weather</a>
    <a href="news.html" aria-current="page">News</a>
  </nav>

  <main>
    <h1>News</h1>
    <p>Edit the feeds directly in this file: look for the <code class="inline">FEEDS</code> array below and add/remove URLs.</p>

    <div id="status" class="meta"></div>
    <div id="articles" class="grid"></div>
  </main>

  <script>
    // ===== Edit your feeds here =====
    const FEEDS = [
      'https://www.dr.dk/nyheder/service/feeds/allenyheder',
      'https://nrkbeta.no/feed/',
      'https://feeds.arstechnica.com/arstechnica/index/'
    ];

    // Public fallback CORS proxy (no signup; best-effort uptime).
    const PROXY_BASE = 'https://api.allorigins.win/raw?url=';

    async function fetchText(url) {
      try {
        const res = await fetch(url, { headers: { 'Accept': 'application/rss+xml, application/atom+xml, application/xml;q=0.9, */*;q=0.8' } });
        if (res.ok) return await res.text();
      } catch (e) {}
      const proxied = PROXY_BASE + encodeURIComponent(url);
      const res2 = await fetch(proxied);
      if (!res2.ok) throw new Error('Proxy fetch failed');
      return await res2.text();
    }

    async function fetchFeed(url) {
      const xmlText = await fetchText(url);
      const xml = new DOMParser().parseFromString(xmlText, 'application/xml');
      const parseError = xml.querySelector('parsererror');
      if (parseError) throw new Error('Invalid XML');
      return xml;
    }

    function extractItems(xml, max=10) {
      const items = Array.from(xml.querySelectorAll('item, entry')).slice(0, max);
      const feedTitle = xml.querySelector('channel > title, feed > title')?.textContent?.trim() || '';
      return items.map(node => {
        const title = node.querySelector('title')?.textContent?.trim() || 'Untitled';
        const linkEl = node.querySelector('link');
        const href = (linkEl && linkEl.getAttribute && linkEl.getAttribute('href')) || (linkEl && linkEl.textContent) || '#';
        const link = href.startsWith('http') ? href : href.replace(/^\\/+/, 'https://');
        const pub = node.querySelector('pubDate, updated, published')?.textContent || '';
        const sourceTitle = feedTitle || (link ? new URL(link, location.href).hostname : 'Feed');
        const desc = node.querySelector('description, summary, content')?.textContent || '';
        return { title, link, pub, sourceTitle, desc };
      });
    }

    function renderArticles(allItems) {
      const grid = document.getElementById('articles');
      grid.innerHTML = '';
      allItems.forEach(item => {
        const card = document.createElement('article');
        card.className = 'card';
        const dateStr = item.pub ? new Date(item.pub).toLocaleString() : '';
        const short = item.desc ? item.desc.replace(/<[^>]*>/g, '').slice(0, 200) : '';
        card.innerHTML = `
          <h3><a href="${item.link}" target="_blank" rel="noopener noreferrer">${item.title}</a></h3>
          <div class="meta"><span class="source">${item.sourceTitle}</span>${dateStr ? ' · <span>' + dateStr + '</span>' : ''}</div>
          ${short ? '<div>' + short + '…</div>' : ''}
        `;
        grid.appendChild(card);
      });
    }

    async function refresh() {
      const status = document.getElementById('status');
      const grid = document.getElementById('articles');
      grid.innerHTML = '';
      status.textContent = 'Loading feeds…';

      const results = await Promise.allSettled(
        FEEDS.map(async (url) => {
          try {
            const xml = await fetchFeed(url);
            const items = extractItems(xml, 8);
            return items;
          } catch (e) {
            return { error: true, url };
          }
        })
      );

      const okItems = [];
      const errors = [];
      results.forEach((r, i) => {
        if (r.status === 'fulfilled' && !r.value?.error) {
          okItems.push(...r.value);
        } else {
          errors.push(FEEDS[i]);
        }
      });

      okItems.sort((a,b) => {
        const ta = Date.parse(a.pub || '') || 0;
        const tb = Date.parse(b.pub || '') || 0;
        return tb - ta;
      });

      renderArticles(okItems);

      if (errors.length) {
        status.innerHTML = '<span class="error">Some feeds failed to load:</span> ' + errors.map(u => {
          try { return new URL(u).hostname; } catch { return u; }
        }).join(', ');
      } else {
        status.textContent = 'All feeds loaded.';
      }
    }

    refresh();
  </script>
</body>
</html>
